<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>migration.main &#8212; XMLRPC Data Migration  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="../../_static/agogo.css?v=8513425a" />
    <script src="../../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
  </head><body>
    <div class="header-wrapper" role="banner">
      <div class="header">
        <div class="headertitle"><a
          href="../../index.html">XMLRPC Data Migration  documentation</a></div>
        <div class="rel" role="navigation" aria-label="related navigation">
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a>
        </div>
       </div>
    </div>

    <div class="content-wrapper">
      <div class="content">
        <div class="document">
            
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for migration.main</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Union</span>
<span class="kn">from</span> <span class="nn">dotenv</span> <span class="kn">import</span> <span class="n">load_dotenv</span>

<span class="kn">from</span> <span class="nn">tools</span> <span class="kn">import</span> <span class="n">Pretty</span>

<span class="kn">from</span> <span class="nn">migrate</span> <span class="kn">import</span> <span class="n">Executor</span>


<div class="viewcode-block" id="account_payment_term_line_value_transformer">
<a class="viewcode-back" href="../../reference/main.html#migration.main.account_payment_term_line_value_transformer">[docs]</a>
<span class="k">def</span> <span class="nf">account_payment_term_line_value_transformer</span><span class="p">(</span><span class="n">executor</span><span class="p">:</span> <span class="n">Executor</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    To migrate account/payment.term.lines from odoo v14 to v17.</span>
<span class="sd">    </span>
<span class="sd">    Changes to make:</span>
<span class="sd">        - Field value can be only fixed or in percentage.</span>
<span class="sd">        - if value == percentage, then value_amount should have a total / sum of 100.0</span>

<span class="sd">    Args:</span>
<span class="sd">        executor (Executor): The executor instance.</span>
<span class="sd">        data (dict): The data to format. All model records at once.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: The formatted data for the target instance.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">line_ids</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">new_line_ids</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># to fix percentages</span>
    <span class="n">keep_percent</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">remaining_percent</span> <span class="o">=</span> <span class="mf">100.0</span>

    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">element</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">line_ids</span><span class="p">):</span>

        <span class="c1"># if first element is a percent, then all elements should be in percent</span>
        <span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">element</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;value&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;percent&quot;</span><span class="p">,</span> <span class="s2">&quot;balance&quot;</span><span class="p">]:</span>
            <span class="n">keep_percent</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">keep_percent</span><span class="p">:</span>
            <span class="n">element</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;percent&quot;</span>
            <span class="k">if</span> <span class="n">element</span><span class="p">[</span><span class="s2">&quot;value_amount&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mf">0.0</span> <span class="ow">or</span> <span class="n">element</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;value&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;balance&quot;</span><span class="p">,</span> <span class="s2">&quot;fixed&quot;</span><span class="p">]:</span>
                <span class="n">element</span><span class="p">[</span><span class="s2">&quot;value_amount&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">remaining_percent</span>
        <span class="n">remaining_percent</span> <span class="o">-=</span> <span class="n">element</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;value_amount&quot;</span><span class="p">)</span>

        <span class="n">new_line_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">new_line_ids</span></div>



<div class="viewcode-block" id="crm_lead_categorizacin_transformer">
<a class="viewcode-back" href="../../reference/main.html#migration.main.crm_lead_categorizacin_transformer">[docs]</a>
<span class="k">def</span> <span class="nf">crm_lead_categorizacin_transformer</span><span class="p">(</span><span class="n">executor</span><span class="p">:</span> <span class="n">Executor</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    To migrate a custom crm.lead model from odoo v14 to v17.</span>
<span class="sd">    </span>
<span class="sd">    Changes to make:</span>
<span class="sd">        - Custom Field x_studio_categorizacin merges with field description.</span>

<span class="sd">    Args:</span>
<span class="sd">        executor (Executor): The executor instance.</span>
<span class="sd">        data (dict): The data to format. All model records at once.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: The formatted data for the target instance.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">pass</span></div>



<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>

    <span class="c1"># connection data is loaded from .env file</span>
    <span class="n">ex</span> <span class="o">=</span> <span class="n">Executor</span><span class="p">()</span>

    <span class="c1"># teams</span>
    <span class="c1"># =================================================================================================</span>
    <span class="n">model</span> <span class="o">=</span> <span class="s1">&#39;crm.team&#39;</span>
    <span class="c1"># fields = [&#39;name&#39;, &#39;sequence&#39;, &#39;active&#39;, &#39;is_favorite&#39;, &#39;color&#39;, &#39;alias_name&#39;, &#39;alias_contact&#39;, &#39;invoiced_target&#39;]</span>

    <span class="c1"># ex.migrate(source, target, model, fields)</span>

    <span class="c1"># payment terms</span>
    <span class="c1"># =================================================================================================</span>
    <span class="n">model</span> <span class="o">=</span> <span class="s1">&#39;account.payment.term&#39;</span>
    <span class="c1"># fields = [&#39;name&#39;, &#39;active&#39;, &#39;note&#39;, {&#39;line_ids&#39;: account_payment_term_line_ids_transformer}]</span>

    <span class="c1"># ex.migrate(source, target, model, fields)</span>

    <span class="c1"># partners</span>
    <span class="c1"># =================================================================================================</span>
    <span class="c1"># model = &quot;res.partner&quot;</span>
    <span class="c1"># fields = [</span>
    <span class="c1">#     {&quot;name&quot;: &quot;name&quot;},</span>
    <span class="c1">#     {&quot;date&quot;: &quot;date&quot;},</span>
    <span class="c1">#     {&quot;title&quot;: &quot;title&quot;}, # this field is a Many2one relation</span>
    <span class="c1">#     # {&quot;parent_id&quot;: &quot;parent_id&quot;},  # this field is a Many2one relation</span>
    <span class="c1">#     {&quot;ref&quot;: &quot;ref&quot;},</span>
    <span class="c1">#     {&quot;lang&quot;: &quot;lang&quot;},</span>
    <span class="c1">#     {&quot;tz&quot;: &quot;tz&quot;},</span>
    <span class="c1">#     {&quot;vat&quot;: &quot;vat&quot;},</span>
    <span class="c1">#     {&quot;website&quot;: &quot;website&quot;},</span>
    <span class="c1">#     {&quot;comment&quot;: &quot;comment&quot;},</span>
    <span class="c1">#     {&quot;credit_limit&quot;: &quot;credit_limit&quot;},</span>
    <span class="c1">#     {&quot;active&quot;: &quot;active&quot;},</span>
    <span class="c1">#     {&quot;employee&quot;: &quot;employee&quot;},</span>
    <span class="c1">#     {&quot;function&quot;: &quot;function&quot;},</span>
    <span class="c1">#     {&quot;type&quot;: &quot;type&quot;},</span>
    <span class="c1">#     {&quot;street&quot;: &quot;street&quot;},</span>
    <span class="c1">#     {&quot;street2&quot;: &quot;street2&quot;},</span>
    <span class="c1">#     {&quot;zip&quot;: &quot;zip&quot;},</span>
    <span class="c1">#     {&quot;city&quot;: &quot;city&quot;},</span>
    <span class="c1">#     {&quot;state_id&quot;: &quot;state_id&quot;}, # this field is a Many2one relation</span>
    <span class="c1">#     {&quot;country_id&quot;: &quot;country_id&quot;}, # this field is a Many2one relation</span>
    <span class="c1">#     {&quot;partner_latitude&quot;: &quot;partner_latitude&quot;},</span>
    <span class="c1">#     {&quot;partner_longitude&quot;: &quot;partner_longitude&quot;},</span>
    <span class="c1">#     {&quot;mobile&quot;: &quot;mobile&quot;},</span>
    <span class="c1">#     {&quot;is_company&quot;: &quot;is_company&quot;},</span>
    <span class="c1">#     {&quot;industry_id&quot;: &quot;industry_id&quot;}, # this field is a Many2one relation</span>
    <span class="c1">#     {&quot;company_type&quot;: &quot;company_type&quot;},</span>
    <span class="c1">#     {&quot;color&quot;: &quot;color&quot;},</span>
    <span class="c1">#     {&quot;partner_share&quot;: &quot;partner_share&quot;},</span>
    <span class="c1">#     {&quot;company_name&quot;: &quot;company_name&quot;},</span>
    <span class="c1">#     {&quot;barcode&quot;: &quot;barcode&quot;},</span>
    <span class="c1">#     {&quot;email&quot;: &quot;email&quot;},</span>
    <span class="c1">#     {&quot;phone&quot;: &quot;phone&quot;},</span>
    <span class="c1">#     {&quot;signup_token&quot;: &quot;signup_token&quot;},</span>
    <span class="c1">#     {&quot;signup_type&quot;: &quot;signup_type&quot;},</span>
    <span class="c1">#     {&quot;signup_expiration&quot;: &quot;signup_expiration&quot;},</span>
    <span class="c1">#     {&quot;signup_valid&quot;: &quot;signup_valid&quot;},</span>
    <span class="c1">#     {&quot;signup_url&quot;: &quot;signup_url&quot;},</span>
    <span class="c1">#     {&quot;additional_info&quot;: &quot;additional_info&quot;},</span>
    <span class="c1">#     {&quot;credit&quot;: &quot;credit&quot;},</span>
    <span class="c1">#     {&quot;debit&quot;: &quot;debit&quot;},</span>
    <span class="c1">#     {&quot;debit_limit&quot;: &quot;debit_limit&quot;},</span>
    <span class="c1">#     {&quot;currency_id&quot;: &quot;currency_id&quot;}, # this field is a Many2one relation</span>
    <span class="c1">#     {&quot;invoice_warn&quot;: &quot;invoice_warn&quot;},</span>
    <span class="c1">#     {&quot;invoice_warn_msg&quot;: &quot;invoice_warn_msg&quot;},</span>
    <span class="c1">#     {&quot;supplier_rank&quot;: &quot;supplier_rank&quot;},</span>
    <span class="c1">#     {&quot;customer_rank&quot;: &quot;customer_rank&quot;},</span>
    <span class="c1">#     {&quot;sale_warn&quot;: &quot;sale_warn&quot;},</span>
    <span class="c1">#     {&quot;sale_warn_msg&quot;: &quot;sale_warn_msg&quot;},</span>
    <span class="c1">#     {&quot;is_blacklisted&quot;: &quot;is_blacklisted&quot;},</span>
    <span class="c1">#     {&quot;phone_blacklisted&quot;: &quot;phone_blacklisted&quot;},</span>
    <span class="c1">#     {&quot;mobile_blacklisted&quot;: &quot;mobile_blacklisted&quot;},</span>
    <span class="c1">#     {&quot;create_date&quot;: &quot;create_date&quot;},</span>
    <span class="c1"># ]</span>

    <span class="c1"># ex.migrate(model, fields, batch_size=100)</span>
   
    <span class="c1"># leads</span>
    <span class="c1"># =================================================================================================</span>
    <span class="c1"># model = &quot;crm.lead&quot;</span>

    <span class="n">recursion</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="n">res</span> <span class="o">=</span> <span class="n">ex</span><span class="o">.</span><span class="n">make_fields_map</span><span class="p">(</span><span class="n">model_name</span><span class="o">=</span><span class="n">model</span><span class="p">,</span> <span class="n">recursion_level</span><span class="o">=</span><span class="n">recursion</span><span class="p">)</span>
    <span class="n">file_path</span> <span class="o">=</span> <span class="s2">&quot;./&quot;</span> <span class="o">+</span> <span class="n">model</span> <span class="o">+</span> <span class="s2">&quot;.txt&quot;</span>
    <span class="n">Pretty</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">file_path</span><span class="o">=</span><span class="n">file_path</span><span class="p">)</span>
    
    <span class="c1"># ex.add_transformer(model=model, </span>
    <span class="c1">#                    field=&quot;x_studio_categorizacin&quot;, transformer=crm_lead_categorizacin_transformer)</span>
    <span class="c1"># ex.add_transformer(model=&quot;account.payment.term&quot;, </span>
    <span class="c1">#                    field=&quot;line_ids&quot;, transformer=account_payment_term_line_ids_transformer)</span>
    
    <span class="n">_map</span> <span class="o">=</span> <span class="n">ex</span><span class="o">.</span><span class="n">load_fields_map</span><span class="p">(</span><span class="n">file_path</span><span class="o">=</span><span class="n">file_path</span><span class="p">)</span>
    
    <span class="n">ex</span><span class="o">.</span><span class="n">migrate</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">_map</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">recursion_level</span><span class="o">=</span><span class="n">recursion</span><span class="p">)</span>
    
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
        </div>
        <div class="sidebar">
          
          <h3>Table of Contents</h3>
          <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../tutorial/tutorial.html">Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../howto.html">HowTo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../explanation.html">Explanation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../reference/reference.html">Reference</a></li>
</ul>

          <search role="search">
            <h3 style="margin-top: 1.5em;">Search</h3>
            <form class="search" action="../../search.html" method="get">
                <input type="text" name="q" />
                <input type="submit" value="Go" />
            </form>
          </search>

        </div>
        <div class="clearer"></div>
      </div>
    </div>

    <div class="footer-wrapper">
      <div class="footer">
        <div class="left">
          <div role="navigation" aria-label="related navigation">
            <a href="../../py-modindex.html" title="Python Module Index"
              >modules</a> |
            <a href="../../genindex.html" title="General Index"
              >index</a>
          </div>
          <div role="note" aria-label="source link">
          </div>
        </div>

        <div class="right">
          
    <div class="footer" role="contentinfo">
    &#169; Copyright 2024, Yoandy M.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.3.7.
    </div>
        </div>
        <div class="clearer"></div>
      </div>
    </div>

  </body>
</html>